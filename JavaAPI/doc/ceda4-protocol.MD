## CEDA4 通讯协议


### meta header 

1. ceda传输使用小端字节序 
2. 消息起始位置为1个字节的magic number 0x82
3. 第2字节开始为变长的消息长度字段，消息长度超过126字节时，第2字节固定0x74(126), 由第3-4字节作为长度字段，注意消息长度字段不包含magic  number0x82及长度字段自身的长度。

```
0                7               15                23              31
+----------------+----------------+----------------+----------------+
|   MAGIC NUM    | message length |    message length  part2        |
|     0x82       |  part1 <=0X74  |          (optional)             |
+----------------+----------------+----------------+----------------+
     
```

### control message 
1. 长度字段后为 一个字节的消息类型字段, ceda包含两类消息，控制类消息和数据消息，
2. 控制消息包括 heartbeat(0x01), login(0x13), logout(0x14), subscribe(0x11), unsubscribe(0x12)
3. 数据消息包含publish(0x61), request(0x62), reply(0x63), p2p(0x64), group pub(0x65),   

#### heartbeat: 0x01
心跳消息仅包含类型字段

```
0                7
+----------------+
|  message type  |
|    0X01        |
+----------------+    
    
```

#### logout: 0x14
登出仅包含类型字段
```
0                7
+----------------+
|  message type  |
|    0X14        |
+----------------+
   16  -  23      
    
```

#### subscribe: 0x11

#### unsubscribe: 0x12
#### login: 0x13

订阅，取消订阅，登录三种消息包含1个字节的消息类型，1个字节的控制代码，以及消息体，消息体长度由消息总体长度减去前序字段。

```

0                7                15
+----------------+----------------+
|  message type  |  Control CODE  | 
| 0X11|0X12|0X13 |                |
+----------------+----------------+
|             messagebody        ...
+---------------------------------+
```
### data message:

#### publish: 0x61

数据发布属于广播类消息，由服务端完成消息匹配转发，消息字段包括 message type, topic, message body,

```
0                7               15
+----------------+----------------+
|   message type | topic length   |
|      0X61      |                |
+----------------+----------------+
|            topic               ...
+----------------+----------------+
|         message body           ...
+----------------+----------------+
```

#### request: 0x62

rpc请求类消息需要提供两端信息，用于路由以及回复，所以包括message type, topic，connection ID,  server ID, signal ID, reply topic和 message body

```
0    2           7               15
+----------------+----------------+
|  message type  |topic length    | 
|     0x62       |                | 
+----------------+----------------+
|            topic               ...
+---------------------------------
|conn| 
| ID | 
+----------------+----------------+
| sever ID len   |  server ID    ... 
+----------------+----------------+
| signal ID      |  signal ID  
|     len        |               ... 
+----------------+----------------+
| reply topic    |  reply topic  
|    len         |               ... 
+----------------+----------------+
|         message body           ...
+----------------+----------------+
    
```
####  reply: 0x63
#### P2P: 0x64 (not used)
#### pub group: 0x65 (not used)

reply, p2p消息不需要提回复rpc的 地址reply topic, 较request消息少一个reply topic字段

p2p消息代表点对点的消息流，同样无需reply topic

pub group表示应用组播，暂未完全支持

```
0    2           7               15
+----------------+----------------+
|  message type  |  topic length  | 
| 0x63|0x64|0x65 |                | 
+----------------+----------------+
|            topic               ...
+---------------------------------
|conn| 
| ID | 
+----------------+----------------+
| sever ID len   |  server ID    ... 
+----------------+----------------+
| signal ID      |  signal ID  
|     len        |               ... 
+----------------+----------------+   
|         message body           ...
+----------------+----------------+

```
